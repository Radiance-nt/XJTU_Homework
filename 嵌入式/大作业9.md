# 嵌入式系统 - 9

将振动传感器的输出作为外部中断请求直接交给S3C2440，需要经过以下几个步骤：

### 连接振动传感器和比较器

将振动传感器的输出接入比较器的正极，比较器的负极接地。比较器的输出可以直接作为S3C2440的外部中断请求引脚的输入。

##### 选项1

原理图中这个电路的作用是将输入电压VCC50稳压为3.3V和1.2V，分别输出到VCC33和LT1117-1.2-SOT223的O段（我之前写成了VCC50）。其中，LMS1587-3.3和LT1117-1.2-SOT223是线性稳压器，用于将输入电压稳定为3.3V和1.2V，以供电子元件使用。

![img](file:///D:\qqdata\1808154289\Image\C2C\MAP7L3SLAYT{5XJEA`42KDG.png)

将开关和LMS1587-3.3连接到S3C2440处理器的**EINT0**引脚上，当开关状态改变时，就可以通过EINT0引脚触发中断。

##### 选项2

模块采用常开高灵敏度震动开关SW-18010P作为振动传感器。该开关在默认状态下呈闭合状态，当传感器受到震动时，开关会由关闭状态瞬间变化到开启状态，并在震动消失后恢复到默认状态。

开关信号经过LM393比较器处理后输出最终的开关量信号。比较器通过与参考电压进行比较，可以输出相应的开关量信号。参考电压可以通过可调精密电位器进行调节，从而控制模块的灵敏度，避免因气流等原因引起的微小振动发生误报情况。模块的工作电压在DC3.3-5V之间，可以通过电源模块或电池等供电方式进行供电。

模块输出引脚与S3C2440处理器的**EINT0**引脚相连。当开关状态改变时，就可以通过EINT0引脚触发中断。

![img](file:///D:\qqdata\1808154289\Image\C2C\8B4Y9~6JUOX047$`YQ3F$9X.png)



### 中断请求引脚

S3C2440的外部中断请求引脚是IRQ，位于CPU的外部接口EINT中。

我们需要将比较器的输出连接到**EINT0/GPF0**引脚上，这样当振动传感器检测到震动时，比较器的输出会产生电平变化，从而触发IRQ引脚产生外部中断请求信号。

![image-20230423130753701](C:\Users\Radiance\AppData\Roaming\Typora\typora-user-images\image-20230423130753701.png)

### 配置外部中断请求

SW-18010P是一个震动开关，其输出信号为脉冲信号，需要通过中断方式来检测其状态变化。

将SW-18010P连接到EINT0/GPF0引脚，将该引脚配置为中断输入模式，配置中断触发方式为上升沿触发。编写相应的中断服务程序来处理中断事件。

在S3C2440处理器中，GPIO控制寄存器GPFCON（GPF  Configurator）用于控制GPFx引脚的输入/输出状态和电平状态。每个GPIO引脚有两个位用于配置其输入/输出状态和电平状态，所以GPFCON寄存器中每两个连续的位对应一个GPIO引脚。对于GPF0引脚而言，它对应GPFCON寄存器中的第0、1位。

为了将GPF0引脚配置为EINT0中断输入引脚，需要将GPF0引脚配置为中断输入模式，并将其配置为EINT0。具体来说，可以先将GPF0引脚的状态设置为中断输入模式，即将GPFCON寄存器中对应的两个位清零；然后，将GPF0引脚配置为EINT0，即将GPFCON寄存器中对应的两个位设置为“10”，代表EINT0中断输入模式。

我们将GPF0引脚的输入/输出状态配置为中断输入模式，即将GPFCON寄存器中对应的两个位清零，使用了“&=~”运算符。

我们又将GPF0引脚配置为EINT0中断输入引脚，即将GPFCON寄存器中对应的两个位设置为“10”，使用了“|=（2 << 0）”运算符。

```c
    // 配置GPF0为EINT0
    GPFCON &= ~(3<<0);
    GPFCON |= (2<<0);

    // 配置中断触发方式，配置EINT0为上升沿触发
    EXTINT0 &= ~(7<<0);
    EXTINT0 |= (4<<0);
```

#### 编写中断服务程序，处理外部中断请求。

编写外部中断服务程序，当检测到振动传感器触发时，调用子程序。我们分别调用以太帧发送报警和向SD CARD写入报警日志的子程序。

```c
#define BLOCK_SIZE 256
#define ALARM_BASE 0xfff000
int seq = 0;
unsigned char * alarm_msg = "trig";
// 处理振动传感器的子程序
void handle_vibration_sensor() {
    seq ++;
    
    // 调用以太帧发送报警的子程序
    dm_tran_packet(alarm_msg, sizeof(alarm_msg));

    // 调用向SD CARD写入报警日志的子程序
    write_log(seq, alarm_msg);
}
```

